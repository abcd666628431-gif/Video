<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>影片庫統計系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* 兼容繁簡中文的 Noto Sans 字體導入 */
        @import url('https://gs.jurieo.com/gemini/fonts-googleapis/css2?family=Noto+Sans+SC:wght@400;700;900&family=Noto+Sans+TC:wght@400;700;900&display=swap');
        
        body { 
            /* 優先使用繁體與簡體字型，確保文字不破字 */
            font-family: 'Noto Sans TC', 'Noto Sans SC', sans-serif; 
            background-color: #3f5968; 
            color: #fff;
            margin: 0;
            overflow-x: hidden;
            font-size: 16px;
            user-select: text;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }
        
        .animate-text-shimmer {
            background: linear-gradient(to right, #ffffff, #ffbae9, #818cf8, #ffffff);
            background-size: 200% auto;
            color: transparent;
            -webkit-background-clip: text;
            background-clip: text;
            animation: shimmer 4s linear infinite;
        }
        @keyframes shimmer { to { background-position: 200% center; } }

        .tab-content { width: 100%; margin-top: 1rem; }
        
        .tab-bar { 
            display: flex; 
            flex-wrap: wrap; 
            align-items: center;
            position: relative; 
            margin-bottom: 1.5rem; 
            gap: 0.75rem;
            padding: 0.5rem 0.5rem 0.8rem 0.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .tab { 
            font-weight: 900; 
            color: #3f5968; 
            cursor: pointer; 
            font-size: 0.85rem;
            transition: all 0.3s;
            text-transform: uppercase;
            background-color: #ffffff; 
            padding: 6px 18px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            white-space: nowrap;
            flex-shrink: 0;
            border: 2px solid transparent;
        }
        .tab:hover { border-color: #ffbae9; }
        .tab.active { 
            background-color: #ffbae9; 
            color: #3f5968;
            border-color: #ffffff;
        }

        .tab-action-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #ffffff;
            color: #3f5968;
            border-radius: 4px;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.2s;
            flex-shrink: 0;
            position: relative;
        }
        .tab-action-btn:hover { transform: scale(1.1); z-index: 10; }
        .tab-action-btn.btn-plus:hover { background: #ffbae9; }
        .tab-action-btn.btn-minus:hover { background: #ef4444; color: #fff; }

        .component-view ul {
            display: grid;
            grid-template-columns: repeat(1, minmax(0, 1fr));
            gap: 1.5rem;
            padding: 0;
            list-style: none;
        }
        @media (min-width: 1024px) {
            .component-view ul { grid-template-columns: repeat(2, minmax(500px, 1fr)); }
        }

        .component-view li {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255,255,255,0.05);
            transition: all 0.3s ease;
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            display: flex;
            padding: 0;
            gap: 0;
            height: 240px; 
        }
        .component-view li:hover {
            background: rgba(0, 0, 0, 0.3);
            border-color: #ffbae9;
            transform: translateY(-2px);
        }
        
        .image-link {
            width: 180px; 
            height: 100%; 
            flex-shrink: 0;
            display: block;
            background: #000;
            transition: width 0.2s ease;
            border-right: 1px solid rgba(255,255,255,0.05);
            position: relative;
        }

        .image {
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
        }
        
        .desc { 
            flex-grow: 1; 
            display: flex; 
            flex-direction: column; 
            min-width: 0; 
            position: relative;
            padding: 0.75rem 1.25rem 1rem 1.25rem; 
        }

        .title-container {
            height: 3.5rem;
            margin-bottom: 0.3rem; 
            display: flex;
            align-items: flex-start;
        }

        .desc .title-link { 
            font-family: 'Noto Sans TC', 'Noto Sans SC', sans-serif;
            font-size: 1.4rem; 
            font-weight: 900; 
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            color: #fff;
            text-decoration: none;
            transition: color 0.2s;
            cursor: pointer;
            line-height: 1.2;
            letter-spacing: -0.01em;
            word-break: break-all;
        }
        .desc .title-link:hover { color: #ffbae9; }

        .id-label {
            background: rgba(254, 249, 195, 0.15);
            color: #fef9c3;
            border: 1px solid rgba(254, 249, 195, 0.4);
            padding: 1px 6px;
            border-radius: 4px;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            font-size: 11px;
            font-weight: 900;
            margin-right: 8px;
            vertical-align: 2px;
            box-shadow: 0 0 10px rgba(254, 249, 195, 0.1);
            display: inline-block;
        }

        .meta { font-size: 0.85rem; color: #cbd5e1; line-height: 1.6; }
        .meta strong { color: #ffbae9; margin-right: 0.3rem; }

        .progress-container {
            width: 100%;
            background: rgba(255,255,255,0.1);
            height: 20px;
            border-radius: 5px;
            margin-top: auto; 
            margin-bottom: 2px;
            overflow: hidden;
            position: relative;
        }
        .progress-fill {
            height: 100%;
            background: #ffbae9;
            transition: width 0.5s ease;
        }
        .progress-text-overlay {
            mix-blend-mode: difference;
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 900;
            color: #fff;
            pointer-events: none;
            letter-spacing: 0.05em;
        }

        .status-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 11px; 
            padding: 3px 8px; 
            border-radius: 4px;
            font-weight: 900;
            text-transform: uppercase;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5); 
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 52px; 
            letter-spacing: 0.05em; 
            text-shadow: 0 1px 1px rgba(0,0,0,0.2); 
            border: 1px solid rgba(255,255,255,0.3);
            line-height: 1.2;
            backdrop-filter: none; 
        }
        .badge-airing { background-color: #16a34a; color: #fff; border-color: rgba(255,255,255,0.4); }
        .badge-completed { background-color: #dc2626; color: #fff; border-color: rgba(255,255,255,0.4); }
        .badge-waiting { background-color: #475569; color: #fff; border-color: rgba(255,255,255,0.4); }

        .dashboard-panel {
            background: rgba(0,0,0,0.25);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 4px;
            padding: 1rem;
        }

        .modal-input-base {
            background: rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.1);
            border-bottom: 2px solid #2d3748;
            padding: 0.5rem 0.75rem;
            transition: all 0.3s ease;
            color: #fff;
            border-radius: 4px;
            min-height: 40px;
        }
        .modal-input-base:focus {
            border-bottom-color: #ffbae9;
            background: rgba(0,0,0,0.7);
            outline: none;
            box-shadow: 0 4px 12px rgba(255, 186, 233, 0.1);
        }
        
        .expand {
            margin-top: 2rem;
            text-align: center;
            font-weight: 900;
            font-size: 12px;
            letter-spacing: 0.2em;
            color: rgba(255,255,255,0.2);
            cursor: pointer;
            transition: color 0.3s;
        }
        .expand:hover { color: #ffbae9; }

        .btn-delete-bottom {
            position: absolute;
            bottom: 12px;
            right: 12px;
            opacity: 0;
            transition: all 0.2s;
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
            padding: 4px 10px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            font-weight: 900;
            border: 1px solid rgba(239, 68, 68, 0.3);
            z-index: 5;
        }
        li:hover .btn-delete-bottom { opacity: 1; }
        .btn-delete-bottom:hover { background: #ef4444; color: #fff; transform: translateY(-2px); }

        .source-icon-small {
            height: 1.1em; 
            width: auto;
            max-width: 24px;
            border-radius: 2px;
            object-fit: contain;
            display: inline-block;
            vertical-align: middle;
            margin-right: 4px;
            position: relative;
            top: -1px; 
        }

        .member-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            background: rgba(255,255,255,0.1);
            font-size: 10px;
            font-weight: 900;
            border: 1px solid rgba(255,255,255,0.15);
            line-height: 1;
        }

        .watcher-tag {
            padding: 4px 10px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 4px;
            font-size: 11px;
            font-weight: 900;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }
        .watcher-tag.active {
            background: #ffbae9;
            color: #3f5968;
            border-color: #fff;
        }

        .progress-stat {
            display: flex;
            align-items: baseline;
            gap: 2px;
        }
        .progress-val-current {
            color: #22d3ee; 
            font-weight: 900;
            font-size: 1.25rem;
            line-height: 1;
        }
        .source-input-group { display: flex; gap: 0.75rem; align-items: flex-start; }
        .source-icon-preview-box {
            width: 40px; height: 40px; border: 1px solid rgba(255,255,255,0.1);
            border-radius: 4px; display: flex; align-items: center; justify-content: center;
            background: #000; cursor: pointer; position: relative; overflow: hidden; flex-shrink: 0;
        }
        .source-icon-preview-box img { width: 100%; height: 100%; object-fit: contain; }
        .source-icon-preview-box.active { border-color: #ffbae9; box-shadow: 0 0 10px rgba(255, 186, 233, 0.3); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://gs.jurieo.com/gemini/gstatic/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://gs.jurieo.com/gemini/gstatic/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, addDoc, updateDoc, deleteDoc, onSnapshot, query, serverTimestamp } from "https://gs.jurieo.com/gemini/gstatic/firebasejs/11.6.1/firebase-firestore.js";

        const { useState, useEffect, useRef, useMemo, memo, useCallback } = React;

        // --- Firebase 設定 ---
        const firebaseConfig = {
            apiKey: "AIzaSyA-bOghSL8apcO6NEda6nc_-_UO6-h9SDs",
            authDomain: "video-b02b3.firebaseapp.com",
            projectId: "video-b02b3",
            storageBucket: "video-b02b3.firebasestorage.app",
            messagingSenderId: "25339039789",
            appId: "1:25339039789:web:6bc5a86b6e2cf39a1f68a4"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'video-library-v1';

        // 格式化日期：確保回傳的一定是字串，避免渲染物件導致報錯
        const formatDate = (ts, dateOnly = false) => { 
            if (!ts) return ""; 
            if (typeof ts === 'string') return ts;

            let date;
            try {
                if (ts && typeof ts.toDate === 'function') {
                    date = ts.toDate();
                } else if (ts && ts.seconds !== undefined) {
                    date = new Date(ts.seconds * 1000);
                } else if (ts instanceof Date) {
                    date = ts;
                } else {
                    date = new Date(ts);
                }
            } catch (e) { 
                return "NOW"; 
            }

            if (!date || isNaN(date.getTime())) return "NOW";
            
            const Y = date.getFullYear();
            const M = (date.getMonth() + 1).toString().padStart(2, '0');
            const D = date.getDate().toString().padStart(2, '0');
            
            if (dateOnly) return `${Y}-${M}-${D}`;
            
            const h = date.getHours().toString().padStart(2, '0');
            const m = date.getMinutes().toString().padStart(2, '0');
            return `${Y}-${M}-${D} ${h}:${m}`; 
        };

        const compressImage = (dataUrl, maxWidth = 400) => {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width; let height = img.height;
                    if (width > maxWidth) {
                        height = Math.round((height * maxWidth) / width);
                        width = maxWidth;
                    }
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.8));
                };
                img.src = dataUrl;
            });
        };

        const Icon = memo(({ name, className, onClick, title }) => {
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [name]);
            return (
                <span onClick={(e) => { if(onClick) { e.stopPropagation(); onClick(e); } }} className={`inline-flex items-center justify-center cursor-pointer ${className || ''}`} title={title}>
                    <i data-lucide={name} style={{ width: '100%', height: '100%' }}></i>
                </span>
            );
        });

        const TitleIcon = () => (
            <svg className="w-14 h-14" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg">
                <path d="M7.741394999999999 28.34337L28.254675 28.34337C29.447565000000004 28.34337 30.414675000000003 27.376275 30.414675000000003 26.183370000000004L30.414675000000003 9.510465C30.414675000000003 8.317544999999999 29.447565000000004 7.350465 28.254675 7.350465L7.74141 7.350465C6.548475 7.350465 5.58141 8.317544999999999 5.58141 9.510465L5.58141 26.183370000000004C5.58141 27.376275 6.548475 28.34337 7.741394999999999 28.34337z" fill="#9796EDff"></path>
                <path d="M8.237805 10.726875C8.237805 11.323335 8.721345 11.806875 9.317805 11.806875L11.308215 11.806875C11.904675 11.806875 12.388215 11.323335 12.388215 10.726875C12.388215 10.130415 11.904675 9.646875000000001 11.308215 9.646875000000001L9.317805 9.646875000000001C8.721345 9.646875000000001 8.237805 10.130415 8.237805 10.726875z" fill="#6D69E4ff"></path>
                <path d="M16.03455 10.726875C16.03455 11.323335 16.51809 11.806875 17.11455 11.806875L19.104915000000002 11.806875C19.70136 11.806875 20.184915 11.323335 20.184915 10.726875C20.184915 10.130415 19.70136 9.646875000000001 19.104915000000002 9.646875000000001L17.11455 9.646875000000001C16.51809 9.646875000000001 16.03455 10.130415 16.03455 10.726875z" fill="#6D69E4ff"></path>
                <path d="M23.830995 10.726875C23.830995 11.323335 24.314550000000004 11.806875 24.910995 11.806875L26.901359999999997 11.806875C27.497805 11.806875 27.981360000000002 11.323335 27.981360000000002 10.726875C27.981360000000002 10.130415 27.497805 9.646875000000001 26.901359999999997 9.646875000000001L24.910995 9.646875000000001C24.314550000000004 9.646875000000001 23.830995 10.130415 23.830995 10.726875z" fill="#6D69E4ff"></path>
                <path d="M8.237805 25.721130000000002C8.237805 26.317725 8.721345 26.80113 9.317805 26.80113L11.308215 26.80113C11.904675 26.80113 12.388215 26.317725 12.388215 25.721130000000002C12.388215 25.124685 11.904675 24.641130000000004 11.308215 24.641130000000004L9.317805 24.641130000000004C8.721345 24.641130000000004 8.237805 25.124685 8.237805 25.721130000000002z" fill="#6D69E4ff"></path>
                <path d="M16.03455 25.721130000000002C16.03455 26.317725 16.51809 26.80113 17.11455 26.80113L19.104915000000002 26.80113C19.70136 26.80113 20.184915 26.317725 20.184915 25.721130000000002C20.184915 25.124685 19.70136 24.641130000000004 19.104915000000002 24.641130000000004L17.11455 24.641130000000004C16.51809 24.641130000000004 16.03455 25.124685 16.03455 25.721130000000002z" fill="#6D69E4ff"></path>
                <path d="M23.830995 25.721130000000002C23.830995 26.317725 24.314550000000004 26.80113 24.910995 26.80113L26.901359999999997 26.80113C27.497805 26.80113 27.981360000000002 26.317725 27.981360000000002 25.721130000000002C27.981360000000002 25.124685 27.497805 24.641130000000004 26.901359999999997 24.641130000000004L24.910995 24.641130000000004C24.314550000000004 24.641130000000004 23.830995 25.124685 23.830995 25.721130000000002z" fill="#6D69E4ff"></path>
                <path d="M5.58141 22.43865L30.414675000000003 22.43865L30.414675000000003 13.253910000000001L5.58141 13.253910000000001L5.58141 22.43865z" fill="#6D69E4ff"></path>
                <path d="M14.81745 19.422C14.87304 19.271805 14.900835 19.196640000000002 14.928195 19.16151C15.043244999999999 19.013475 15.26703 19.013475 15.38223 19.16151C15.40944 19.196640000000002 15.437235 19.271805 15.49281 19.422C15.802275000000002 20.258355 16.461645 20.917725 17.298000000000002 21.22719C17.44833 21.282765 17.52336 21.31056 17.55849 21.33792C17.706525 21.45297 17.706525 21.676755 17.55849 21.791805C17.52336 21.819165 17.44833 21.846960000000003 17.298000000000002 21.902549999999998C16.461645 22.212 15.802275000000002 22.87137 15.49281 23.707725C15.437235 23.85792 15.40944 23.933085 15.38223 23.968230000000002C15.26703 24.11625 15.043244999999999 24.11625 14.928195 23.968230000000002C14.900835 23.933085 14.87304 23.85792 14.81745 23.707725C14.508000000000001 22.87137 13.84863 22.212 13.012305000000001 21.902549999999998C12.86205 21.846960000000003 12.786930000000002 21.819165 12.751845 21.791805C12.60381 21.676755 12.60381 21.45297 12.751845 21.33792C12.786930000000002 21.31056 12.86205 21.282765 13.012305000000001 21.22719C13.84863 20.917725 14.508000000000001 20.258355 14.81745 19.422z" fill="#FDDE80ff"></path>
                <path d="M20.13192 10.496220000000001C20.259075 10.15269 20.32257 9.980910000000002 20.384925 9.90072C20.64816 9.56226 21.159795 9.56226 21.423029999999997 9.90072C21.48537 9.980910000000002 21.548879999999997 10.15269 21.676035 10.496220000000001C22.38351 12.408375 23.89119 13.915994999999999 25.803359999999998 14.623635C26.14695 14.75064 26.318595 14.814284999999998 26.3988 14.876639999999998C26.73735 15.139875 26.73735 15.65136 26.3988 15.914595000000002C26.318595 15.976950000000002 26.14695 16.040595 25.803359999999998 16.167749999999998C23.89119 16.87521 22.38351 18.38289 21.676035 20.295074999999997C21.548879999999997 20.638514999999998 21.48537 20.81031 21.423029999999997 20.890515C21.159795 21.22905 20.64816 21.22905 20.384925 20.890515C20.32257 20.81031 20.259075 20.638514999999998 20.13192 20.295074999999997C19.424310000000002 18.38289 17.916764999999998 16.87521 16.004595 16.167749999999998C15.661005000000001 16.040595 15.48921 15.976950000000002 15.409005 15.914595000000002C15.070605 15.65136 15.070605 15.139875 15.409005 14.876639999999998C15.48921 14.814284999999998 15.661005000000001 14.75064 16.004595 14.623635C17.916764999999998 13.915994999999999 19.424310000000002 12.408375 20.13192 10.496220000000001z" fill="#FDDE80ff"></path>
            </svg>
        );

        const GameCard = memo(({ g, onOpenEdit, isEditLocked, onDelete, nameColorMap, allSources }) => {
            const addedByColor = nameColorMap?.[g.addedBy] || '#ffffff';
            const total = parseInt(g.totalEpisodes) || 0;
            const current = parseFloat(g.watchedProgress) || 0;
            const percentage = total > 0 ? Math.floor(Math.min((current / total) * 100, 100)) : 0;
            const watchingByList = Array.isArray(g.watchingBy) ? g.watchingBy : (g.watchingBy ? [g.watchingBy] : []);

            const sourceInfo = useMemo(() => allSources.find(s => s.name === g.source), [allSources, g.source]);

            const getStatusBadge = () => {
                if (!g.airingStatus) return null;
                let cls = "badge-waiting";
                if (g.airingStatus === "連載中") cls = "badge-airing";
                if (g.airingStatus === "已完結") cls = "badge-completed";
                return <span className={`status-badge ${cls}`}>{g.airingStatus}</span>;
            };

            const getDisplayUpdateTime = (timeStr) => {
                if (!timeStr) return "";
                const parts = timeStr.split(':');
                if (parts.length < 2) return timeStr;
                const [h, m] = parts.map(Number);
                const period = h >= 12 ? '下午' : '上午';
                const displayH = h % 12 || 12;
                return `${period} ${String(displayH).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
            };

            return (
                <li className={`group ${!isEditLocked ? 'cursor-pointer' : ''}`} onClick={() => !isEditLocked && onOpenEdit(g)}>
                    <div className="image-link" onClick={e => { if (isEditLocked && g.url) window.open(g.url, '_blank'); }}>
                        {getStatusBadge()}
                        {g.cover ? (
                            <div className="image" style={{ backgroundImage: `url(${g.cover})` }}></div>
                        ) : (
                            <div className="w-full h-full flex items-center justify-center bg-black/40 text-white/10"><Icon name="image" className="w-8 h-8" /></div>
                        )}
                    </div> 

                    <div className="desc">
                        <div className="title-container">
                            <div className="title-link">
                                <span className="id-label">#{g.order || 0}</span>
                                {g.name}
                            </div> 
                        </div>
                        
                        <div className="meta space-y-1.5 flex-1 flex flex-col justify-start">
                            <div className="flex items-center flex-wrap gap-x-1 opacity-90">
                                <strong>分類：</strong> {g.category || '未分類'} | 
                                <span className="inline-flex items-center ml-1">
                                    {sourceInfo?.icon && <img src={sourceInfo.icon} className="source-icon-small" />}
                                    {g.source || '未知來源'}
                                </span>
                            </div>
                            
                            <div className="text-[11px] opacity-90">
                                <strong>更新進度：</strong> 
                                <span className="text-white/95">更新至 {g.updatedEpisodes || 0} / {total || '?'} 集</span>
                                {(g.updateDay || g.updateTime) && (
                                    <span className="ml-2 text-[#ffbae9] font-black border-l border-white/20 pl-2">
                                        每周{g.updateDay ? `(${g.updateDay})` : ''} {getDisplayUpdateTime(g.updateTime)}
                                    </span>
                                )}
                            </div>

                            <div className="mt-auto pt-2">
                                <div className="flex justify-between items-center w-full gap-2">
                                    <div className="flex items-center gap-1.5 flex-shrink-0">
                                        <strong className="text-[11px]">觀看進度：</strong>
                                        <div className="progress-stat">
                                            <span className="progress-val-current">{g.watchedProgress || 0}</span>
                                            <span className="text-[11px] text-white/50 ml-1 font-black">集</span>
                                        </div>
                                    </div>
                                    {watchingByList.length > 0 && (
                                        <div className="flex flex-wrap items-center justify-end gap-1 flex-1">
                                            <strong className="text-[10px] text-cyan-400 whitespace-nowrap">誰在看：</strong>
                                            <div className="flex flex-wrap justify-end gap-1">
                                                {watchingByList.map(name => {
                                                    const color = nameColorMap?.[name] || '#ffffff';
                                                    return <span key={name} className="member-badge" style={{ color: color, backgroundColor: color + '15', borderColor: color + '30' }}>{name}</span>;
                                                })}
                                            </div>
                                        </div>
                                    )}
                                </div>

                                <div className="flex justify-between items-center w-full mt-2 pt-1.5 border-t border-white/10 mb-1.5"> 
                                    <div className="truncate text-[10px]">
                                        <strong className="opacity-50 text-[9px] uppercase">創建</strong> 
                                        <span className="member-badge !py-0.5 ml-1" style={{ color: addedByColor, backgroundColor: addedByColor + '10', borderColor: addedByColor + '20' }}>{String(g.addedBy || '系統')}</span>
                                    </div>
                                    <div className="text-[10px] opacity-60">
                                        最後更新: {formatDate(g.manualUpdatedAt) || formatDate(g.updatedAt || g.createdAt) || "LIVE"}
                                    </div>
                                </div>

                                <div className="progress-container">
                                    <div className="progress-fill" style={{ width: `${percentage}%` }}></div>
                                    <div className="progress-text-overlay">{percentage}%</div>
                                </div>
                            </div>
                        </div>

                        {!isEditLocked && (
                            <button onClick={(e) => { e.stopPropagation(); onDelete(g); }} className="btn-delete-bottom">
                                <Icon name="trash-2" className="w-3 h-3" /> 移除資料
                            </button>
                        )}
                    </div>
                </li>
            );
        });

        function App() {
            const [user, setUser] = useState(null);
            const [games, setGames] = useState([]); 
            const importInputRef = useRef(null);
            const fileInputRef = useRef(null);

            const [notification, setNotification] = useState(null);
            const showNotify = useCallback((msg) => { 
                setNotification(msg); 
                setTimeout(() => setNotification(null), 3000); 
            }, []);

            const [onlineUsers, setOnlineUsers] = useState([]);
            const [activityLogs, setActivityLogs] = useState([]);
            const [isLoadingLogs, setIsLoadingLogs] = useState(true);
            const [isLoadingGames, setIsLoadingGames] = useState(true);
            const [isSyncing, setIsSyncing] = useState(false);
            const [lastSynced, setLastSynced] = useState(null);
            
            const [userName, setUserName] = useState(() => localStorage.getItem('steam_user_name') || '用戶_' + Math.floor(Math.random()*1000));
            const [userColor, setUserColor] = useState(() => localStorage.getItem('steam_user_color') || '#ffbae9');
            const [isEditingName, setIsEditingName] = useState(false);
            
            const [customCategories, setCustomCategories] = useState([]);
            const [customSources, setCustomSources] = useState([]);
            const [activeTab, setActiveTab] = useState(null); 
            
            const [isAddGroupModalOpen, setIsAddGroupModalOpen] = useState(false);
            const [newGroupName, setNewGroupName] = useState('');

            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingId, setEditingId] = useState(null); 
            const [formData, setFormData] = useState({ 
                name: '', addedBy: '', order: '', url: '', cover: null,
                totalEpisodes: '', watchedProgress: '', updatedEpisodes: '', airingStatus: '連載中', source: '', category: '',
                sourceIcon: '', manualUpdatedAt: '', watchingBy: [], updateDay: '', updateTime: '18:00'
            });

            const [lastSelectedImgZone, setLastSelectedImgZone] = useState('cover');
            const [searchQuery, setSearchQuery] = useState(''); 
            const [isEditLocked, setIsEditLocked] = useState(true);
            const [showClearConfirm, setShowClearConfirm] = useState(false);
            const [deleteGameTarget, setDeleteGameTarget] = useState(null);

            const getPublicCol = (col) => collection(db, 'artifacts', appId, 'public', 'data', col);

            const nameColorMap = useMemo(() => {
                const map = {};
                onlineUsers.forEach(u => { if(u.name) map[u.name] = u.color; });
                map[userName] = userColor;
                games.forEach(g => { 
                    if(g.addedBy && !map[g.addedBy]) map[g.addedBy] = '#cbd5e1';
                    if(Array.isArray(g.watchingBy)) g.watchingBy.forEach(n => { if(!map[n]) map[n] = '#cbd5e1'; });
                });
                return map;
            }, [onlineUsers, userName, userColor, games]);

            const allMemberIDs = useMemo(() => {
                const ids = new Set([userName]);
                onlineUsers.forEach(u => ids.add(u.name));
                games.forEach(g => {
                    if(g.addedBy) ids.add(g.addedBy);
                    if(Array.isArray(g.watchingBy)) g.watchingBy.forEach(n => ids.add(n));
                });
                return Array.from(ids).filter(Boolean).sort();
            }, [userName, onlineUsers, games]);

            const handlePaste = useCallback(async (e) => {
                if (!isModalOpen) return;
                const items = (e.clipboardData || e.originalEvent.clipboardData).items;
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf("image") !== -1) {
                        const blob = items[i].getAsFile();
                        const url = URL.createObjectURL(blob);
                        const compressed = await compressImage(url, lastSelectedImgZone === 'source' ? 100 : 400);
                        if (lastSelectedImgZone === 'source') setFormData(prev => ({ ...prev, sourceIcon: compressed }));
                        else setFormData(prev => ({ ...prev, cover: compressed }));
                        showNotify("圖片已貼上");
                        break;
                    }
                }
            }, [isModalOpen, lastSelectedImgZone, showNotify]);

            useEffect(() => {
                window.addEventListener('paste', handlePaste);
                return () => window.removeEventListener('paste', handlePaste);
            }, [handlePaste]);

            useEffect(() => {
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            try {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } catch (tokenErr) {
                                await signInAnonymously(auth);
                            }
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (e) { console.error("Auth failed", e); }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, setUser);
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) return;
                setIsLoadingGames(true);
                setIsLoadingLogs(true);
                
                // Firestore 即時同步監聽
                const unsubGames = onSnapshot(getPublicCol('games'), (snap) => {
                    setGames(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                    setIsLoadingGames(false);
                    // 每次雲端有變動時更新同步時間點
                    setLastSynced(new Date());
                }, (err) => {
                    if (err.code === 'permission-denied') showNotify("權限不足");
                });
                const unsubLogs = onSnapshot(getPublicCol('activity_logs'), (snap) => {
                    const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    list.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                    setActivityLogs(list.slice(0, 30));
                    setIsLoadingLogs(false);
                });
                const unsubSettings = onSnapshot(doc(getPublicCol('settings'), 'config'), (d) => {
                    if (d.exists()) {
                        const data = d.data();
                        setCustomCategories(data.categories || ["最新入庫", "編號排序"]);
                        setCustomSources(data.sources || []);
                    } else {
                        setDoc(doc(getPublicCol('settings'), 'config'), { categories: ["最新入庫", "編號排序"], sources: [] });
                    }
                });
                const unsubPresence = onSnapshot(getPublicCol('presence'), (snap) => {
                    const now = Date.now();
                    setOnlineUsers(snap.docs.map(d => d.data()).filter(u => u.lastSeen && (now - u.lastSeen.toMillis() < 300000)));
                });
                const updatePresence = () => {
                    if (!auth.currentUser) return;
                    setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'presence', auth.currentUser.uid), {
                        uid: auth.currentUser.uid, name: userName, color: userColor, lastSeen: serverTimestamp()
                    }, { merge: true });
                };
                updatePresence();
                const interval = setInterval(updatePresence, 120000); // 每一分鐘更新一次在線狀態
                return () => { unsubGames(); unsubLogs(); unsubSettings(); unsubPresence(); clearInterval(interval); };
            }, [user, userName, userColor]);

            const logActivity = async (action, gameName) => { 
                if(!user) return;
                try {
                    await addDoc(getPublicCol('activity_logs'), {
                        userName, action: String(action), gameName: String(gameName), timestamp: serverTimestamp()
                    });
                } catch(e) {}
            };

            const handleAddGroup = async () => {
                if(!user) return;
                const name = (newGroupName || '').trim();
                if (!name || customCategories.includes(name)) return;
                await updateDoc(doc(getPublicCol('settings'), 'config'), { categories: [...customCategories, name] });
                setNewGroupName(''); setIsAddGroupModalOpen(false); showNotify("分組已新增");
            };

            const handleDeleteGroup = async () => {
                if (!user || !activeTab) return;
                await updateDoc(doc(getPublicCol('settings'), 'config'), { categories: customCategories.filter(c => c !== activeTab) });
                setActiveTab(null); showNotify("分組已刪除");
            };

            const handleSaveGame = async (e) => {
                if (e) e.preventDefault();
                const currentName = (formData.name || '').trim();
                if (!currentName || !user) return;
                
                try {
                    const allCurrentOrders = games.map(g => parseInt(g.order)).sort((a,b) => a-b);
                    let targetOrder;
                    if (!formData.order || formData.order === "") {
                        targetOrder = 1;
                        while (allCurrentOrders.includes(targetOrder)) targetOrder++;
                    } else {
                        targetOrder = parseInt(formData.order);
                    }
                    
                    let currentConflict = games.find(g => parseInt(g.order) === targetOrder && g.id !== editingId);
                    if (currentConflict) {
                        showNotify("編號衝突，正在智慧順延...");
                        let shiftChain = [];
                        let checkNum = targetOrder;
                        while (true) {
                            let itemAtNum = games.find(g => parseInt(g.order) === checkNum && g.id !== editingId);
                            if (itemAtNum) { shiftChain.push(itemAtNum); checkNum++; }
                            else break;
                        }
                        shiftChain.reverse();
                        const shiftPromises = shiftChain.map(item => {
                            return updateDoc(doc(getPublicCol('games'), item.id), { order: parseInt(item.order) + 1 });
                        });
                        await Promise.all(shiftPromises);
                    }

                    const sourceVal = (formData.source || '').trim();
                    if (sourceVal) {
                        let updatedSources = [...customSources];
                        const sIcon = formData.sourceIcon || '';
                        const idx = updatedSources.findIndex(s => s.name === sourceVal);
                        if (idx === -1) updatedSources.push({ name: sourceVal, icon: sIcon });
                        else updatedSources[idx].icon = sIcon;
                        await setDoc(doc(getPublicCol('settings'), 'config'), { sources: updatedSources, categories: customCategories }, { merge: true });
                    }

                    const finalData = { 
                        ...formData,
                        name: currentName,
                        source: sourceVal,
                        addedBy: String(formData.addedBy || userName),
                        order: targetOrder,
                        manualUpdatedAt: String(formData.manualUpdatedAt || ""),
                        updateDay: String(formData.updateDay || ""),
                        updateTime: String(formData.updateTime || ""),
                        updatedAt: serverTimestamp() 
                    };
                    delete finalData.sourceIcon;

                    if (editingId) {
                        await updateDoc(doc(getPublicCol('games'), editingId), finalData);
                        logActivity("修改", finalData.name);
                    } else {
                        await addDoc(getPublicCol('games'), { ...finalData, createdAt: serverTimestamp() });
                        logActivity("錄入", finalData.name);
                    }
                    showNotify("資料已儲存"); setIsModalOpen(false); setEditingId(null);
                } catch (err) {
                    console.error("Save error:", err);
                    showNotify("操作失敗");
                }
            };

            const handleDeleteGame = async (id) => {
                if(!user) return;
                const g = games.find(x => x.id === id);
                await deleteDoc(doc(getPublicCol('games'), id));
                logActivity("刪除", g?.name || "未知");
                showNotify("已刪除"); setDeleteGameTarget(null);
            };

            const handleClearAllData = async () => {
                if(!user) return;
                try {
                    for (const game of games) await deleteDoc(doc(getPublicCol('games'), game.id));
                    showNotify("資料已清空");
                    setShowClearConfirm(false);
                } catch (e) { showNotify("操作失敗"); }
            };

            const handleExportData = () => {
                const backup = { version: "11.6", games, categories: customCategories, sources: customSources };
                const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `backup_video_library_${Date.now()}.json`;
                a.click();
            };

            const handleImportData = async (e) => {
                const file = e.target.files[0];
                if (!file || !user) return;
                const reader = new FileReader();
                reader.onload = async (ev) => {
                    try {
                        const data = JSON.parse(ev.target.result);
                        showNotify("正在恢復...");
                        if (data.games) {
                            for (const g of data.games) {
                                const { id, ...gd } = g;
                                await addDoc(getPublicCol('games'), gd);
                            }
                        }
                        if (data.categories || data.sources) {
                            await setDoc(doc(getPublicCol('settings'), 'config'), { categories: data.categories || customCategories, sources: data.sources || customSources }, { merge: true });
                        }
                        showNotify("資料導入成功");
                    } catch (err) { showNotify("導入失敗"); }
                };
                reader.readAsText(file);
            };

            const filteredGames = useMemo(() => {
                let list = [...games];
                const q = (searchQuery || '').toLowerCase().trim();
                if (q) list = list.filter(g => (g.name||"").toLowerCase().includes(q) || (g.category||"").toLowerCase().includes(q));
                
                if (activeTab === "最新入庫") {
                    list.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                } else {
                    if (activeTab && activeTab !== "編號排序") list = list.filter(g => g.category === activeTab);
                    list.sort((a, b) => (parseInt(a.order) || 0) - (parseInt(b.order) || 0));
                }
                return list;
            }, [games, searchQuery, activeTab]);

            const memberStats = useMemo(() => {
                const statsMap = {};
                games.forEach(g => {
                    const watchers = Array.isArray(g.watchingBy) ? g.watchingBy : (g.watchingBy ? [g.watchingBy] : []);
                    watchers.forEach(name => {
                        if (!statsMap[name]) statsMap[name] = { total: 0, unstarted: 0, watching: 0, completed: 0 };
                        statsMap[name].total++;
                        const total = parseInt(g.totalEpisodes) || 0;
                        const current = parseFloat(g.watchedProgress) || 0;
                        const p = total > 0 ? (current / total) * 100 : 0;
                        if (p === 0) statsMap[name].unstarted++;
                        else if (p >= 100) statsMap[name].completed++;
                        else statsMap[name].watching++;
                    });
                });
                return Object.keys(statsMap).sort().map(name => ({ name, color: nameColorMap[name] || '#ffffff', stats: statsMap[name] }));
            }, [games, nameColorMap]);

            const TimeSelector = ({ value, onChange }) => {
                const parts = (value || "18:00").split(':');
                const h = parseInt(parts[0]) || 0;
                const m = parseInt(parts[1]) || 0;
                const period = h >= 12 ? '下午' : '上午';
                const displayH = h % 12 || 12;
                const updateTime = (newPeriod, newH, newM) => {
                    let finalH = parseInt(newH);
                    if (newPeriod === '下午' && finalH !== 12) finalH += 12;
                    if (newPeriod === '上午' && finalH === 12) finalH = 0;
                    onChange(`${String(finalH).padStart(2, '0')}:${String(newM).padStart(2, '0')}`);
                };
                return (
                    <div className="flex gap-2 w-full">
                        <select className="modal-input-base flex-1 text-xs font-black" value={period} onChange={(e) => updateTime(e.target.value, displayH, m)}>
                            <option value="上午">上午</option><option value="下午">下午</option>
                        </select>
                        <select className="modal-input-base flex-1 text-xs font-black" value={displayH} onChange={(e) => updateTime(period, e.target.value, m)}>
                            {Array.from({ length: 12 }, (_, i) => i + 1).map(val => <option key={val} value={val}>{String(val).padStart(2, '0')} 時</option>)}
                        </select>
                        <select className="modal-input-base flex-1 text-xs font-black" value={m} onChange={(e) => updateTime(period, displayH, e.target.value)}>
                            {Array.from({ length: 60 }, (_, i) => i).map(val => <option key={val} value={val}>{String(val).padStart(2, '0')} 分</option>)}
                        </select>
                    </div>
                );
            };

            return (
                <div className="min-h-screen p-4 md:p-8 relative text-white pb-24">
                    {notification && <div className="fixed top-4 left-1/2 -translate-x-1/2 z-[100] bg-[#ffbae9] text-[#3f5968] font-black px-6 py-2 rounded-full border-2 border-white shadow-2xl">{notification}</div>}
                    <div className="max-w-[1800px] mx-auto">
                        <header className="mb-8 flex flex-col md:flex-row items-center justify-between gap-4">
                            <div className="flex items-center gap-6">
                                <TitleIcon />
                                <div>
                                    <div className="flex items-center gap-2 mb-1"><div className="w-2 h-2 bg-[#ffbae9]"></div><span className="text-xs font-black text-white/60 tracking-widest uppercase">Anime Matrix v11.6</span></div>
                                    <h1 className="text-4xl md:text-5xl font-black uppercase tracking-tighter">影片 <span className="animate-text-shimmer">庫統計系統</span></h1>
                                </div>
                            </div>
                            <div className="flex items-center gap-3">
                                <div className="flex items-center gap-2 px-4 py-2 border rounded text-xs font-black bg-black/20 border-white/20">
                                    <Icon name="refresh-cw" className={`w-4 h-4 ${isSyncing ? 'animate-spin' : ''}`} onClick={() => { setIsSyncing(true); setTimeout(()=>setIsSyncing(false), 800); }} />
                                    <div className="flex flex-col">
                                        <span className="uppercase text-[10px]">即時同步中</span>
                                        <span className="text-[10px] text-white/40 font-bold">{lastSynced ? formatDate(lastSynced) : '...'}</span>
                                    </div>
                                </div>
                                {!isEditLocked && <button onClick={() => setShowClearConfirm(true)} className="flex items-center gap-2 px-4 py-2 bg-red-900/40 border border-red-500/30 text-red-100 text-xs font-black rounded hover:bg-red-600 uppercase transition-all shadow-lg"><Icon name="trash-2" className="w-4 h-4" /> 清除</button>}
                            </div>
                        </header>
                        
                        <div className="grid grid-cols-1 lg:grid-cols-10 gap-6 mb-8">
                            <div className="lg:col-span-4 dashboard-panel h-[180px] overflow-hidden flex flex-col">
                                <div className="flex items-center gap-2 mb-2 border-b border-white/5 pb-1 font-black text-white/50 text-xs uppercase"><Icon name="history" className="w-4 h-4 text-[#ffbae9]" /> 操作日誌</div>
                                <div className="flex-1 overflow-y-auto custom-scrollbar font-mono text-[13px] space-y-1 text-white/70">
                                    {activityLogs.map(log => (
                                        <div key={log.id} className="border-b border-white/5 pb-0.5">
                                            <span className="text-white/30 text-[10px] mr-2">[{formatDate(log.timestamp).split(' ')[1]}]</span> 
                                            <span className="font-bold" style={{ color: nameColorMap[log.userName] }}>{String(log.userName)}</span> {String(log.action)} <span className="font-black">"{String(log.gameName)}"</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                            <div className="lg:col-span-2 dashboard-panel h-[180px] flex flex-col gap-3">
                                <div className="flex justify-between items-center text-xs font-black text-white/50 uppercase"><span>在線</span><span className="text-xl font-black text-white">{onlineUsers.length}</span></div>
                                <div className="bg-black/20 border border-white/5 p-2 flex-1 overflow-y-auto custom-scrollbar text-[11px] rounded flex flex-wrap gap-2">
                                    {onlineUsers.map(u => <span key={u.uid} style={{ color: u.color }} className="font-black">● {String(u.name)}</span>)}
                                </div>
                                <div className="flex justify-between items-center pt-1 border-t border-white/5">
                                    <div className="flex items-center gap-2 cursor-pointer" onClick={() => setIsEditingName(true)}>
                                        {isEditingName ? <input autoFocus className="bg-black border-b border-[#ffbae9] text-[11px] w-20 outline-none" defaultValue={userName} onBlur={e => { const v=e.target.value.trim()||userName; setUserName(v); localStorage.setItem('steam_user_name', v); setIsEditingName(false); }} /> : <span className="text-xs font-black" style={{ color: userColor }}>{userName}</span>}
                                        <Icon name="edit-3" className="w-3 h-3 text-white/20" />
                                    </div>
                                    <input type="color" className="w-6 h-6 bg-transparent cursor-pointer" value={userColor} onChange={e => { setUserColor(e.target.value); localStorage.setItem('steam_user_color', e.target.value); }} />
                                </div>
                            </div>
                            <div className="lg:col-span-4 dashboard-panel h-[180px] relative flex flex-col">
                                <div className="absolute top-0 left-0 w-full h-[2px] bg-[#ffbae9]"></div>
                                <div className="flex justify-between items-center mb-2 text-xs font-black text-white/50 uppercase tracking-widest">
                                    <div className="flex items-center gap-3">
                                        <span>成員統計</span>
                                        <Icon name="download" className="w-3.5 h-3.5 hover:text-white" onClick={handleExportData} title="導出 JSON 備份" />
                                        <Icon name="upload" className="w-3.5 h-3.5 hover:text-white" onClick={() => importInputRef.current.click()} title="導入 JSON 備份" />
                                        <input type="file" ref={importInputRef} className="hidden" accept=".json" onChange={handleImportData} />
                                    </div>
                                </div>
                                <div className="flex-1 overflow-y-auto custom-scrollbar pr-1">
                                    <table className="w-full text-[11px] font-black border-collapse">
                                        <thead>
                                            <tr className="text-left text-white/30 border-b border-white/5">
                                                <th className="pb-1">成員</th><th className="pb-1 text-center">總數</th><th className="pb-1 text-center">未開始</th><th className="pb-1 text-center text-cyan-400">觀看中</th><th className="pb-1 text-center text-green-400">已看完</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {memberStats.map(m => (
                                                <tr key={m.name} className="border-b border-white/5 hover:bg-white/5">
                                                    <td className="py-1.5" style={{ color: m.color }}>{m.name}</td><td className="py-1.5 text-center">{m.stats.total}</td><td className="py-1.5 text-center opacity-40">{m.stats.unstarted}</td><td className="py-1.5 text-center text-cyan-400/60">{m.stats.watching}</td><td className="py-1.5 text-center text-green-400/60">{m.stats.completed}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div className="flex flex-col md:flex-row items-stretch md:items-center bg-black/20 border border-white/10 rounded-t-lg overflow-hidden shadow-xl">
                            <button onClick={() => { setEditingId(null); setFormData({ name: '', addedBy: userName, order: (games.length + 1).toString(), url: '', cover: null, totalEpisodes: '', watchedProgress: '', updatedEpisodes: '', airingStatus: '連載中', source: '', category: '', sourceIcon: '', manualUpdatedAt: formatDate(new Date(), true), watchingBy: [], updateDay: '', updateTime: '18:00' }); setIsModalOpen(true); }} className="px-10 py-5 bg-[#ffbae9] text-[#3f5968] font-black border-l-8 border-white uppercase tracking-widest text-sm">+ 錄入新內容</button>
                            <div className="flex-grow flex items-center px-8 border-y md:border-y-0 border-white/5 py-4 md:py-0">
                                <Icon name="search" className="w-5 h-5 text-white/40 mr-4" />
                                <input type="text" placeholder="搜尋標題或分類..." className="bg-transparent outline-none uppercase font-black tracking-widest text-sm flex-grow placeholder:text-white/20" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} />
                            </div>
                            <div className="px-8 flex items-center justify-end py-4 md:py-0">
                                <button onClick={() => setIsEditLocked(!isEditLocked)} className={`px-6 py-2 rounded-full font-black text-xs border transition-all ${isEditLocked ? 'text-[#ffbae9] border-[#ffbae9]/50 bg-[#ffbae9]/10' : 'text-green-300 border-green-500/50 bg-green-500/10'}`}>
                                    <Icon name={isEditLocked ? "lock" : "unlock"} className="w-3 h-3 mr-2 inline" />
                                    {isEditLocked ? "唯讀模式" : "管理模式"}
                                </button>
                            </div>
                        </div>

                        <article className="tab-content bg-black/10 border-x border-b border-white/10 p-6 rounded-b-lg shadow-2xl">
                            <nav className="tab-bar">
                                {customCategories.map((cat, idx) => (
                                    <div key={idx} className={`tab ${activeTab === cat ? 'active' : ''}`} onClick={() => setActiveTab(prev => prev === cat ? null : cat)}>{cat}</div>
                                ))}
                                <div className="ml-auto flex gap-2 pr-2">
                                    {!isEditLocked && <div className="tab-action-btn btn-plus" onClick={() => setIsAddGroupModalOpen(true)}><Icon name="plus" className="w-4 h-4" /></div>}
                                    {!isEditLocked && activeTab && <div className="tab-action-btn btn-minus" onClick={handleDeleteGroup}><Icon name="minus" className="w-4 h-4" /></div>}
                                </div>
                            </nav> 
                            <div className="component-view">
                                <ul>
                                    {isLoadingGames ? <div className="col-span-full py-20 text-center animate-pulse text-white/20 font-black">SYNCHRONIZING...</div> :
                                    filteredGames.length === 0 ? <div className="col-span-full py-20 text-center text-white/10 font-black uppercase">目前無資料</div> :
                                    filteredGames.map(g => (
                                        <GameCard key={g.id} g={g} nameColorMap={nameColorMap} allSources={customSources} isEditLocked={isEditLocked} 
                                            onOpenEdit={(item) => { 
                                                setEditingId(item.id); 
                                                const sObj = customSources.find(s => s.name === item.source);
                                                setFormData({ 
                                                    ...item, name: item.name || '', source: item.source || '',
                                                    manualUpdatedAt: formatDate(item.manualUpdatedAt) || formatDate(item.updatedAt || new Date(), true), 
                                                    updateDay: item.updateDay || '', updateTime: item.updateTime || '18:00',
                                                    sourceIcon: sObj?.icon || '', watchingBy: Array.isArray(item.watchingBy) ? item.watchingBy : [] 
                                                }); 
                                                setIsModalOpen(true); 
                                            }}
                                            onDelete={(item) => setDeleteGameTarget(item)} 
                                        />
                                    ))}
                                </ul>
                            </div> 
                            <div className="expand" onClick={() => showNotify("資料矩陣已刷新")}>REFRESH DATA MATRIX</div>
                        </article>
                    </div>

                    {isAddGroupModalOpen && (
                        <div className="fixed inset-0 z-[300] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
                            <div className="bg-[#0b0e14] border border-white/20 p-6 rounded shadow-2xl w-full max-w-xs text-center">
                                <h4 className="text-sm font-black mb-4 uppercase tracking-widest">新增自定義分組</h4>
                                <input autoFocus className="modal-input-base w-full mb-4 text-sm" placeholder="輸入分組名稱..." value={newGroupName} onChange={e => setNewGroupName(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleAddGroup()}/>
                                <div className="flex gap-2">
                                    <button onClick={() => setIsAddGroupModalOpen(false)} className="flex-1 py-2 bg-white/5 text-[10px] font-black rounded uppercase">取消</button>
                                    <button onClick={handleAddGroup} className="flex-1 py-2 bg-[#ffbae9] text-[#3f5968] text-[10px] font-black rounded uppercase">確定新增</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {isModalOpen && (
                        <div className="fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm overflow-y-auto">
                            <div className="bg-[#0b0e14] border border-white/10 w-full max-w-3xl my-8 overflow-hidden relative shadow-2xl rounded-sm">
                                <div className="absolute top-0 left-0 w-full h-1 bg-[#ffbae9]"></div>
                                <button onClick={() => {setIsModalOpen(false); setEditingId(null);}} className="absolute right-4 top-4 text-slate-600 hover:text-white transition-all z-10"><Icon name="x" className="w-5 h-5" /></button>
                                <div className="p-8">
                                    <h3 className="text-2xl font-black italic mb-8 underline decoration-[#ffbae9]/30 decoration-4 uppercase tracking-tighter">{editingId ? 'Modify' : 'New Entry'} 資料卡</h3>
                                    <form onSubmit={handleSaveGame} className="space-y-6">
                                        <div className="grid grid-cols-1 md:grid-cols-12 gap-8">
                                            <div className="md:col-span-4 space-y-4">
                                                <div onClick={() => { setLastSelectedImgZone('cover'); fileInputRef.current.click(); }} className={`w-full aspect-[3/4.2] bg-black border border-white/10 rounded flex flex-col items-center justify-center cursor-pointer overflow-hidden group hover:border-[#ffbae9] transition-all shadow-xl ${lastSelectedImgZone === 'cover' ? 'border-[#ffbae9] ring-2 ring-[#ffbae9]/20' : ''}`}>
                                                    {formData.cover ? <img src={formData.cover} className="w-full h-full object-cover" /> : <div className="text-center p-4 text-[10px] text-white/20 group-hover:text-[#ffbae9] font-black uppercase leading-relaxed">點擊上傳<br/>或<br/>CTRL+V 貼上</div>}
                                                </div>
                                                <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={async (e)=>{ if(e.target.files[0]) { const c = await compressImage(URL.createObjectURL(e.target.files[0]), lastSelectedImgZone === 'source' ? 100 : 400); if(lastSelectedImgZone === 'source') setFormData(p=>({...p, sourceIcon: c})); else setFormData(p=>({...p, cover: c})); } }} />
                                                <div>
                                                    <label className="block text-[10px] font-black text-white/40 uppercase mb-1.5">編號</label>
                                                    <input type="number" className="modal-input-base w-full text-center font-black" value={formData.order} onChange={e=>setFormData({...formData, order: e.target.value})} placeholder="自動分配最小空號" />
                                                </div>
                                                <div>
                                                    <label className="block text-[10px] font-black text-white/40 uppercase mb-1.5">狀態</label>
                                                    <select className="modal-input-base w-full text-xs font-black" value={formData.airingStatus} onChange={e=>setFormData({...formData, airingStatus: e.target.value})}>
                                                        <option value="連載中">連載中</option><option value="已完結">已完結</option><option value="待播出">待播出</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div className="md:col-span-8 space-y-5">
                                                <div>
                                                    <label className="block text-[11px] font-black text-[#ffbae9]/60 uppercase mb-2">-名稱-</label>
                                                    <input required className="modal-input-base w-full font-black text-white text-lg" value={formData.name} onChange={e=>setFormData({...formData, name: e.target.value})} placeholder="請輸入影片或遊戲標題..." />
                                                </div>
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div>
                                                        <label className="block text-[11px] font-black text-white/40 uppercase mb-2">-分類-</label>
                                                        <select className="modal-input-base w-full text-sm font-bold" value={formData.category} onChange={e=>setFormData({...formData, category: e.target.value})}>
                                                            <option value="">- 選擇分類 -</option>
                                                            {customCategories.map(c => <option key={c} value={c}>{c}</option>)}
                                                        </select>
                                                    </div>
                                                    <div>
                                                        <label className="block text-[11px] font-black text-white/40 uppercase mb-2">-來源 (可輸入或選擇)-</label>
                                                        <div className="source-input-group">
                                                            <div className={`source-icon-preview-box ${lastSelectedImgZone === 'source' ? 'active' : ''}`} onClick={() => setLastSelectedImgZone('source')}>
                                                                {formData.sourceIcon ? <img src={formData.sourceIcon} /> : <Icon name="image" className="w-4 h-4 text-white/20" />}
                                                            </div>
                                                            <input 
                                                                list="source-list"
                                                                className="modal-input-base w-full text-sm font-bold" 
                                                                value={formData.source} 
                                                                onChange={e => {
                                                                    const val = e.target.value;
                                                                    const existing = customSources.find(s => s.name === val);
                                                                    setFormData({
                                                                        ...formData, 
                                                                        source: val,
                                                                        sourceIcon: existing ? existing.icon : formData.sourceIcon
                                                                    });
                                                                }} 
                                                                placeholder="輸入來源..." 
                                                            />
                                                            <datalist id="source-list">
                                                                {customSources.map(s => <option key={s.name} value={s.name} />)}
                                                            </datalist>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div><label className="block text-[11px] font-black text-white/40 uppercase mb-2">-總集數-</label>
                                                        <input type="number" className="modal-input-base w-full font-black text-sm" value={formData.totalEpisodes} onChange={e=>setFormData({...formData, totalEpisodes: e.target.value})} />
                                                    </div>
                                                    <div><label className="block text-[11px] font-black text-white/40 uppercase mb-2">-更新至-</label>
                                                        <input type="number" className="modal-input-base w-full font-black text-sm" value={formData.updatedEpisodes} onChange={e=>setFormData({...formData, updatedEpisodes: e.target.value})} />
                                                    </div>
                                                </div>
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div><label className="block text-[11px] font-black text-white/40 uppercase mb-2">-更新星期-</label>
                                                        <select className="modal-input-base w-full text-sm font-bold" value={formData.updateDay} onChange={e=>setFormData({...formData, updateDay: e.target.value})}>
                                                            <option value="">- 選擇星期 -</option>{['一','二','三','四','五','六','日'].map(d => <option key={d} value={d}>每周 ({d})</option>)}
                                                        </select>
                                                    </div>
                                                    <div><label className="block text-[11px] font-black text-[#ffbae9]/80 uppercase mb-2">-更新時間-</label>
                                                        <TimeSelector value={formData.updateTime} onChange={(newTime) => setFormData({...formData, updateTime: newTime})} />
                                                    </div>
                                                </div>
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div><label className="block text-[11px] font-black text-cyan-400 uppercase mb-2">-觀看進度-</label>
                                                        <input step="any" className="modal-input-base w-full font-black text-cyan-400 text-sm" value={formData.watchedProgress} onChange={e=>setFormData({...formData, watchedProgress: e.target.value})} placeholder="我看完第幾集" />
                                                    </div>
                                                    <div><label className="block text-[11px] font-black text-white/40 uppercase mb-2">-最後更新 (年-月-日)-</label>
                                                        <input className="modal-input-base w-full font-black text-sm" value={formData.manualUpdatedAt} onChange={e=>setFormData({...formData, manualUpdatedAt: e.target.value})} placeholder="2024-01-01" />
                                                    </div>
                                                </div>
                                                <div><label className="block text-[11px] font-black text-white/40 uppercase mb-2">-誰在看 (多選)-</label>
                                                    <div className="flex flex-wrap gap-2 p-2 bg-black/30 border border-white/5 rounded min-h-[40px]">
                                                        {allMemberIDs.map(name => (<div key={name} onClick={() => {
                                                            const list = [...(formData.watchingBy || [])];
                                                            const nList = list.includes(name) ? list.filter(n => n !== name) : [...list, name];
                                                            setFormData({...formData, watchingBy: nList});
                                                        }} className={`watcher-tag ${formData.watchingBy.includes(name) ? 'active' : ''}`}>{name}</div>))}
                                                    </div>
                                                </div>
                                                <div><label className="block text-[11px] font-black text-white/40 uppercase mb-2">-連結-</label>
                                                    <input className="modal-input-base w-full font-mono text-[11px] text-cyan-500" value={formData.url} onChange={e=>setFormData({...formData, url: e.target.value})} placeholder="https://..." />
                                                </div>
                                            </div>
                                        </div>
                                        <div className="pt-6 flex gap-4">
                                            <button type="button" onClick={() => {setIsModalOpen(false); setEditingId(null);}} className="flex-1 py-4 bg-white/5 text-[12px] font-black rounded uppercase hover:bg-white/10 transition-colors border border-white/5">取消修改</button>
                                            <button type="submit" className="flex-[2] py-4 bg-[#ffbae9] text-[#3f5968] text-[12px] font-black rounded shadow-lg uppercase active:scale-95 transition-all">確認提交資料</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    )}

                    {deleteGameTarget && (
                        <div className="fixed inset-0 z-[700] flex items-center justify-center p-4 bg-black/90 backdrop-blur-md">
                            <div className="bg-[#0b0e14] border border-red-500/50 w-full max-w-sm p-10 rounded-sm text-center shadow-2xl">
                                <Icon name="alert-triangle" className="w-12 h-12 text-red-500 mx-auto mb-4" />
                                <h4 className="text-red-500 font-black mb-2 uppercase text-lg">確認刪除？</h4>
                                <p className="text-sm text-slate-300 mb-8 font-bold italic">{String(deleteGameTarget.name)}</p>
                                <div className="flex gap-4">
                                    <button onClick={() => setDeleteGameTarget(null)} className="flex-1 py-3 bg-white/5 text-[12px] font-black rounded border border-white/5 uppercase">取消</button>
                                    <button onClick={() => handleDeleteGame(deleteGameTarget.id)} className="flex-1 py-3 bg-red-600 text-white text-[12px] font-black rounded shadow-lg uppercase">確定</button>
                                </div>
                            </div>
                        </div>
                    )}
                    {showClearConfirm && (
                        <div className="fixed inset-0 z-[600] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
                            <div className="bg-[#0b0e14] border border-red-500/30 w-full max-w-xs p-8 rounded-sm shadow-2xl text-center">
                                <h4 className="text-red-500 font-black mb-4 uppercase tracking-widest">警告：清空全部數據</h4>
                                <p className="text-xs text-white/40 mb-8 leading-relaxed px-2">確定要清空所有內容嗎？此操作不可撤銷。</p>
                                <div className="flex gap-3">
                                    <button onClick={() => setShowClearConfirm(false)} className="flex-1 py-2 bg-white/5 text-[11px] font-black rounded border border-white/5">取消</button>
                                    <button onClick={handleClearAllData} className="flex-1 py-2 bg-red-600 text-white text-[11px] font-black rounded shadow-lg active:scale-95">確定</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
